name: default-test-first-mini
description: Test-First開発ピース（plan → テスト作成 → implement → 並列レビュー → 修正 → 完了）
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 25
initial_movement: plan
movements:
  - name: plan
    edit: false
    persona: planner
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    rules:
      - condition: 要件が明確で実装可能
        next: write_tests
      - condition: ユーザーが質問をしている（実装タスクではない）
        next: COMPLETE
      - condition: 要件が不明確、情報不足
        next: ABORT
    instruction: plan
    output_contracts:
      report:
        - name: plan.md
          format: plan
  - name: write_tests
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    instruction: write-tests-first
    rules:
      - condition: テスト作成が完了した
        next: implement
      - condition: テスト対象が未実装のためテスト作成をスキップする
        next: implement
      - condition: テスト作成を進行できない
        next: ABORT
      - condition: ユーザーへの確認事項があるためユーザー入力が必要
        next: write_tests
        requires_user_input: true
        interactive_only: true
    output_contracts:
      report:
        - name: test-scope.md
          format: coder-scope
        - name: test-decisions.md
          format: coder-decisions
  - name: implement
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    instruction: implement-after-tests
    rules:
      - condition: 実装が完了した
        next: reviewers
      - condition: 実装を進行できない
        next: ABORT
      - condition: ユーザーへの確認事項があるためユーザー入力が必要
        next: implement
        requires_user_input: true
        interactive_only: true
    output_contracts:
      report:
        - name: coder-scope.md
          format: coder-scope
        - name: coder-decisions.md
          format: coder-decisions
  - name: reviewers
    parallel:
      - name: ai_review
        edit: false
        persona: ai-antipattern-reviewer
        policy:
          - review
          - ai-antipattern
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction: review-ai
        rules:
          - condition: AI特有の問題なし
          - condition: AI特有の問題あり
        output_contracts:
          report:
            - name: ai-review.md
              format: ai-review
      - name: supervise
        edit: false
        persona: supervisor
        policy: review
        knowledge: architecture
        allowed_tools:
          - Read
          - Glob
          - Grep
          - Bash
          - WebSearch
          - WebFetch
        instruction: supervise
        rules:
          - condition: すべて問題なし
          - condition: 要求未達成、テスト失敗、ビルドエラー
        output_contracts:
          report:
            - name: supervisor-validation.md
              format: supervisor-validation
            - name: summary.md
              format: summary
              use_judge: false
    rules:
      - condition: all("AI特有の問題なし", "すべて問題なし")
        next: COMPLETE
      - condition: all("AI特有の問題あり", "要求未達成、テスト失敗、ビルドエラー")
        next: fix_both
      - condition: any("AI特有の問題あり")
        next: ai_fix
      - condition: any("要求未達成、テスト失敗、ビルドエラー")
        next: supervise_fix
  - name: fix_both
    parallel:
      - name: ai_fix_parallel
        edit: true
        persona: coder
        policy:
          - coding
          - testing
        knowledge: architecture
        allowed_tools:
          - Read
          - Glob
          - Grep
          - Edit
          - Bash
          - WebSearch
          - WebFetch
        required_permission_mode: edit
        rules:
          - condition: AI問題の修正完了
          - condition: 修正不要（指摘対象ファイル/仕様の確認済み）
          - condition: 判断できない、情報不足
        instruction: ai-fix
      - name: supervise_fix_parallel
        edit: true
        persona: coder
        policy:
          - coding
          - testing
        knowledge: architecture
        allowed_tools:
          - Read
          - Glob
          - Grep
          - Edit
          - Bash
          - WebSearch
          - WebFetch
        required_permission_mode: edit
        rules:
          - condition: 監督者の指摘に対する修正が完了した
          - condition: 修正を進行できない
        instruction: fix-supervisor
    rules:
      - condition: all("AI問題の修正完了", "監督者の指摘に対する修正が完了した")
        next: reviewers
      - condition: any("修正不要（指摘対象ファイル/仕様の確認済み）", "判断できない、情報不足", "修正を進行できない")
        next: implement
  - name: ai_fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    rules:
      - condition: AI問題の修正完了
        next: reviewers
      - condition: 修正不要（指摘対象ファイル/仕様の確認済み）
        next: implement
      - condition: 判断できない、情報不足
        next: implement
    instruction: ai-fix
  - name: supervise_fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    rules:
      - condition: 監督者の指摘に対する修正が完了した
        next: reviewers
      - condition: 修正を進行できない
        next: implement
    instruction: fix-supervisor
